<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug - Navega√ß√£o Swift Gamifica√ß√£o</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .debug-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .debug-button {
        margin: 5px;
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .debug-button:hover {
        background: #0056b3;
      }
      .debug-log {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
        font-family: monospace;
        max-height: 200px;
        overflow-y: auto;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
      .warning {
        color: orange;
      }
    </style>
  </head>
  <body>
    <h1>üîç Debug - Sistema de Navega√ß√£o</h1>

    <div class="debug-section">
      <h2>1. Verificar Componentes Carregados</h2>
      <button class="debug-button" onclick="checkComponents()">Verificar Componentes</button>
      <div id="components-log" class="debug-log"></div>
    </div>

    <div class="debug-section">
      <h2>2. Testar Router</h2>
      <button class="debug-button" onclick="checkRouter()">Verificar Router</button>
      <button class="debug-button" onclick="testNavigation('dashboard')">Navegar: Dashboard</button>
      <button class="debug-button" onclick="testNavigation('login')">Navegar: Login</button>
      <button class="debug-button" onclick="testNavigation('home')">Navegar: Home</button>
      <div id="router-log" class="debug-log"></div>
    </div>

    <div class="debug-section">
      <h2>3. Testar Event Listeners</h2>
      <button class="debug-button" onclick="testEventListeners()">Testar Click Listeners</button>
      <a href="#dashboard" data-route="dashboard" class="debug-button">Link Teste: Dashboard</a>
      <a href="#login" data-navigate="login" class="debug-button">Link Teste: Login</a>
      <div id="events-log" class="debug-log"></div>
    </div>

    <div class="debug-section">
      <h2>4. State Manager</h2>
      <button class="debug-button" onclick="checkStateManager()">Verificar StateManager</button>
      <div id="state-log" class="debug-log"></div>
    </div>

    <div class="debug-section">
      <h2>5. Sistema de Autentica√ß√£o</h2>
      <button class="debug-button" onclick="testLogin()">Testar Login Autom√°tico</button>
      <button class="debug-button" onclick="testLogout()">Testar Logout</button>
      <button class="debug-button" onclick="checkAuthStatus()">Verificar Status de Auth</button>
      <button class="debug-button" onclick="testAuthGuards()">Testar Guards</button>
      <div id="auth-log" class="debug-log"></div>
    </div>

    <div class="debug-section">
      <h2>6. Console Errors</h2>
      <button class="debug-button" onclick="clearConsole()">Limpar Log</button>
      <div id="console-log" class="debug-log"></div>
    </div>

    <!-- Container para testar navega√ß√£o -->
    <div
      id="content"
      style="margin-top: 20px; padding: 20px; border: 2px solid #007bff; border-radius: 5px"
    >
      <p>Conte√∫do ser√° carregado aqui...</p>
    </div>

    <!-- Carregar scripts na mesma ordem do index.html -->
    <script src="src/assets/js/core/BaseComponent.js"></script>
    <script src="src/assets/js/core/StateManager.js"></script>
    <script src="src/assets/js/core/Router.js"></script>
    <script src="src/assets/js/components/HeaderComponent.js"></script>
    <script src="src/assets/js/components/NavigationComponent.js"></script>
    <script src="src/assets/js/components/HomeComponent.js"></script>
    <script src="src/assets/js/components/LoginComponent.js"></script>
    <script src="src/assets/js/components/RegisterComponent.js"></script>
    <script src="src/assets/js/components/dashboard.js"></script>
    <script src="src/assets/js/components/ranking.js"></script>
    <script src="src/assets/js/components/GoalsComponent.js"></script>
    <script src="src/assets/js/components/ProfileComponent.js"></script>
    <script src="src/assets/js/components/AchievementsComponent.js"></script>
    <script src="src/assets/js/utils/api.js"></script>
    <script src="src/assets/js/SwiftGamificationApp.js"></script>

    <script>
      let consoleErrors = [];
      const originalError = console.error;
      const originalLog = console.log;
      const originalWarn = console.warn;

      console.error = function (...args) {
        consoleErrors.push({
          type: 'error',
          message: args.join(' '),
          timestamp: new Date().toLocaleTimeString()
        });
        updateConsoleLog();
        originalError.apply(console, args);
      };

      console.warn = function (...args) {
        consoleErrors.push({
          type: 'warning',
          message: args.join(' '),
          timestamp: new Date().toLocaleTimeString()
        });
        updateConsoleLog();
        originalWarn.apply(console, args);
      };

      function log(message, type = 'info') {
        consoleErrors.push({ type, message, timestamp: new Date().toLocaleTimeString() });
        updateConsoleLog();
      }

      function updateConsoleLog() {
        const logDiv = document.getElementById('console-log');
        logDiv.innerHTML = consoleErrors
          .map(entry => `<div class="${entry.type}">[${entry.timestamp}] ${entry.message}</div>`)
          .join('');
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function checkComponents() {
        const logDiv = document.getElementById('components-log');
        let log = [];

        const expectedComponents = [
          'BaseComponent',
          'ComponentFactory',
          'StateManager',
          'Router',
          'HomeComponent',
          'LoginComponent',
          'RegisterComponent',
          'DashboardComponent',
          'RankingComponent',
          'GoalsComponent',
          'ProfileComponent',
          'AchievementsComponent',
          'NavigationComponent'
        ];

        expectedComponents.forEach(comp => {
          if (window[comp]) {
            log.push(`<div class="success">‚úÖ ${comp} - Carregado</div>`);
          } else {
            log.push(`<div class="error">‚ùå ${comp} - N√ÉO encontrado</div>`);
          }
        });

        logDiv.innerHTML = log.join('');
      }

      function checkRouter() {
        const logDiv = document.getElementById('router-log');
        let log = [];

        if (window.router) {
          log.push(`<div class="success">‚úÖ Router global existe</div>`);
          log.push(`<div>Rota atual: ${window.router.getCurrentRoute()?.name || 'nenhuma'}</div>`);
          log.push(`<div>Rotas registradas: ${window.router.routes?.size || 0}</div>`);

          if (window.router.routes) {
            log.push(`<div><strong>Rotas dispon√≠veis:</strong></div>`);
            window.router.routes.forEach((route, name) => {
              log.push(`<div>  - ${name}: ${route.title}</div>`);
            });
          }
        } else {
          log.push(`<div class="error">‚ùå Router global n√£o existe</div>`);
        }

        if (window.swiftApp) {
          log.push(`<div class="success">‚úÖ SwiftApp existe</div>`);
          log.push(`<div>SwiftApp inicializada: ${window.swiftApp.isInitialized}</div>`);
        } else {
          log.push(`<div class="error">‚ùå SwiftApp n√£o existe</div>`);
        }

        logDiv.innerHTML = log.join('');
      }

      function testNavigation(route) {
        const logDiv = document.getElementById('router-log');

        if (window.router) {
          try {
            const result = window.router.navigate(route);
            const existing = logDiv.innerHTML;
            logDiv.innerHTML =
              existing +
              `<div class="success">[${new Date().toLocaleTimeString()}] Navega√ß√£o para "${route}" executada</div>`;
          } catch (error) {
            const existing = logDiv.innerHTML;
            logDiv.innerHTML =
              existing +
              `<div class="error">[${new Date().toLocaleTimeString()}] Erro ao navegar para "${route}": ${error.message}</div>`;
          }
        } else {
          const existing = logDiv.innerHTML;
          logDiv.innerHTML = existing + `<div class="error">Router n√£o est√° dispon√≠vel</div>`;
        }
      }

      function testEventListeners() {
        const logDiv = document.getElementById('events-log');
        let log = [];

        const testLinks = document.querySelectorAll('[data-route], [data-navigate]');
        log.push(`<div>Encontrados ${testLinks.length} links com data-route/data-navigate</div>`);

        if (testLinks.length > 0) {
          testLinks.forEach((link, index) => {
            log.push(
              `<div>Link ${index + 1}: ${link.getAttribute('data-route') || link.getAttribute('data-navigate')}</div>`
            );
          });
        }

        logDiv.innerHTML = log.join('');
      }

      function checkStateManager() {
        const logDiv = document.getElementById('state-log');
        let log = [];

        if (window.stateManager) {
          log.push(`<div class="success">‚úÖ StateManager existe</div>`);

          try {
            const state = window.stateManager.getState();
            log.push(`<div>Estado atual:</div>`);
            log.push(`<pre>${JSON.stringify(state, null, 2)}</pre>`);
          } catch (error) {
            log.push(`<div class="error">Erro ao obter estado: ${error.message}</div>`);
          }
        } else {
          log.push(`<div class="error">‚ùå StateManager n√£o existe</div>`);
        }

        logDiv.innerHTML = log.join('');
      }

      function clearConsole() {
        consoleErrors = [];
        updateConsoleLog();
      }

      function testLogin() {
        const logDiv = document.getElementById('auth-log');
        let log = [];

        const credentials = {
          codigoLoja: '001',
          codigoFuncionario: '12345',
          cpf: '123.456.789-00',
          senha: '123456'
        };

        log.push(`<div>üîë Testando login com credenciais v√°lidas...</div>`);
        log.push(
          `<div>Loja: ${credentials.codigoLoja}, Funcion√°rio: ${credentials.codigoFuncionario}</div>`
        );

        const authToken = {
          userId: Date.now(),
          cpf: credentials.cpf,
          loginTime: Date.now(),
          expiresIn: 24 * 60 * 60 * 1000
        };

        localStorage.setItem('swift_auth_token', JSON.stringify(authToken));

        if (window.stateManager) {
          const mockUser = {
            id: authToken.userId,
            cpf: credentials.cpf,
            name: 'Teste Usuario',
            email: 'teste@swift.com',
            position: 'Funcion√°rio',
            store: 'Loja 001',
            points: 2500,
            level: 4,
            achievements: ['first-login', 'test-achievement'],
            avatar: null
          };

          window.stateManager.setState({ currentUser: mockUser });
          log.push(`<div class="success">‚úÖ Usu√°rio criado no estado</div>`);
        }

        log.push(`<div class="success">‚úÖ Token de autentica√ß√£o salvo</div>`);
        log.push(`<div class="success">‚úÖ Login simulado com sucesso!</div>`);

        logDiv.innerHTML = log.join('');
      }

      function testLogout() {
        const logDiv = document.getElementById('auth-log');
        let log = [];

        log.push(`<div>üö™ Testando logout...</div>`);

        if (window.swiftApp && window.swiftApp.logout) {
          window.swiftApp.logout();
          log.push(`<div class="success">‚úÖ Logout executado via swiftApp</div>`);
        } else {
          localStorage.removeItem('swift_auth_token');
          localStorage.removeItem('swift_remember_cpf');
          localStorage.removeItem('swift_remember_codigo_loja');

          if (window.stateManager) {
            window.stateManager.setState({ currentUser: null });
          }

          log.push(`<div class="success">‚úÖ Logout manual executado</div>`);
        }

        logDiv.innerHTML = log.join('');
      }

      function checkAuthStatus() {
        const logDiv = document.getElementById('auth-log');
        let log = [];

        log.push(`<div>üîç Verificando status de autentica√ß√£o...</div>`);

        const authToken = localStorage.getItem('swift_auth_token');
        if (authToken) {
          try {
            const tokenData = JSON.parse(authToken);
            const now = Date.now();
            const timeLeft = tokenData.loginTime + tokenData.expiresIn - now;
            const hoursLeft = Math.round(timeLeft / (1000 * 60 * 60));

            log.push(`<div class="success">‚úÖ Token encontrado</div>`);
            log.push(`<div>CPF: ${tokenData.cpf}</div>`);
            log.push(`<div>Login: ${new Date(tokenData.loginTime).toLocaleString()}</div>`);
            log.push(
              `<div>Expira em: ${hoursLeft}h (${timeLeft > 0 ? 'V√°lido' : 'Expirado'})</div>`
            );
          } catch (error) {
            log.push(`<div class="error">‚ùå Token inv√°lido: ${error.message}</div>`);
          }
        } else {
          log.push(`<div class="warning">‚ö†Ô∏è Nenhum token encontrado</div>`);
        }

        if (window.stateManager) {
          const currentUser = window.stateManager.getState('currentUser');
          if (currentUser) {
            log.push(`<div class="success">‚úÖ Usu√°rio no estado: ${currentUser.name}</div>`);
            log.push(`<div>Pontos: ${currentUser.points}, N√≠vel: ${currentUser.level}</div>`);
          } else {
            log.push(`<div class="warning">‚ö†Ô∏è Nenhum usu√°rio no estado</div>`);
          }
        }

        const rememberedCPF = localStorage.getItem('swift_remember_cpf');
        const rememberedLoja = localStorage.getItem('swift_remember_codigo_loja');
        if (rememberedCPF || rememberedLoja) {
          log.push(
            `<div class="info">üíæ Dados salvos - CPF: ${rememberedCPF}, Loja: ${rememberedLoja}</div>`
          );
        } else {
          log.push(`<div>üíæ Nenhum dado salvo para "lembrar de mim"</div>`);
        }

        logDiv.innerHTML = log.join('');
      }

      function testAuthGuards() {
        const logDiv = document.getElementById('auth-log');
        let log = [];

        log.push(`<div>üõ°Ô∏è Testando Guards de autentica√ß√£o...</div>`);

        if (window.commonGuards) {
          const mockRoute = { name: 'dashboard', title: 'Dashboard' };
          const mockFromRoute = { name: 'home', title: 'Home' };

          try {
            const authResult = window.commonGuards.requireAuth(mockRoute, mockFromRoute);
            if (authResult === true) {
              log.push(`<div class="success">‚úÖ requireAuth: Usu√°rio autenticado</div>`);
            } else if (typeof authResult === 'string') {
              log.push(
                `<div class="warning">‚ö†Ô∏è requireAuth: Redirecionar para "${authResult}"</div>`
              );
            } else {
              log.push(`<div class="error">‚ùå requireAuth: Acesso negado</div>`);
            }

            const redirectResult = window.commonGuards.redirectIfAuth(mockRoute, mockFromRoute);
            if (redirectResult === true) {
              log.push(`<div class="success">‚úÖ redirectIfAuth: Pode prosseguir</div>`);
            } else if (typeof redirectResult === 'string') {
              log.push(
                `<div class="warning">‚ö†Ô∏è redirectIfAuth: Redirecionar para "${redirectResult}"</div>`
              );
            }
          } catch (error) {
            log.push(`<div class="error">‚ùå Erro ao testar guards: ${error.message}</div>`);
          }
        } else {
          log.push(`<div class="error">‚ùå commonGuards n√£o encontrado</div>`);
        }

        logDiv.innerHTML = log.join('');
      }

      window.addEventListener('load', () => {
        setTimeout(() => {
          checkComponents();
          checkRouter();
          checkStateManager();
          log('P√°gina de debug carregada', 'success');
        }, 1000);
      });

      document.addEventListener('click', e => {
        const link = e.target.closest('[data-route], [data-navigate]');
        if (link) {
          const route = link.dataset.route || link.dataset.navigate;
          log(`Clique interceptado em link para: ${route}`, 'info');
        }
      });
    </script>
  </body>
</html>
